<center> <h1>CA黑名单</h1> </center>

## 1 名词解释

CA黑名单，别称**证书拒绝列表**（certificate rejected list，简称CRL）。CA黑名单基于`config.ini`文件中`[crl]`配置的NodeID进行判断，拒绝此NodeID节点发起的连接。

CA黑名单[配置类型](../node_access_management.md#21-%E8%8A%82%E7%82%B9%E7%B1%BB%E5%9E%8B)：

- 基于**作用范围**（网络配置/账本配置）维度可划分为**网络配置**，影响整个网络的节点连接建立过程；
- 基于**是否可改**（可改配置/固定配置）维度可划分为**可改配置**，内容可改，重启后生效；
- 基于**存放位置**（本地存储/链上存储）维度可划分为**本地存储**，内容记录在本地，不存于链上。

## 2 模块架构

下图表示CA黑名单所涉及的模块及其关系。图例A->B表示B模块依赖A模块的数据，同时B模块晚于A模块初始化。

![模块架构.png](../../../images/certificate_rejected_list/architecture.png)

## 3 实现流程

底层实现SSL双向验证。节点在handshake过程中，通过对方提供的证书获取对方节点的nodeID，检查该nodeID是否在自身的CA黑名单。如果在，关闭该connect，继续后续流程。

## 4 影响范围

- CA黑名单对网络层的P2P节点连接及AMOP功能有显著影响，**使之失效**；
- 对账本层的共识和同步功能有潜在影响，**影响共识及同步消息/数据的转发**。

## 5 配置格式

节点`config.ini`配置中增加`[crl]`路径（`[crl]`在配置中可选）。CA黑名单内容为节点NodeID列表，node.X为本节点拒绝连接的对方节点NodeID。CA黑名单的配置格式示例如下。

```
[crl]
    crl.0=4d9752efbb1de1253d1d463a934d34230398e787b3112805728525ed5b9d2ba29e4ad92c6fcde5156ede8baa5aca372a209f94dc8f283c8a4fa63e3787c338a4
    crl.1=af57c506be9ae60df8a4a16823fa948a68550a9b6a5624df44afcd3f75ce3afc6bb1416bcb7018e1a22c5ecbd016a80ffa57b4a73adc1aeaff4508666c9b633a
```

## 6 操作示例

### 6.1 A节点将B节点列入CA黑名单

场景描述：

节点1和节点2在群组同一群组中，与群组其余节点轮流出块，现在节点1将节点2加入自身黑名单。

操作顺序：

1. 对于节点1，将节点2的公钥NodeID加入自身的**CA黑名单**；
2. 重启节点1；
3. 使用netstat命令确认节点1与节点2的原有连接已经断开，加入黑名单操作完成。

补充说明：

- 节点1添加节点2到自身CA黑名单的操作，将断开与节点2的网络连接及AMOP通信；
- 节点1添加节点2到自身CA黑名单的操作，将对节点1所在群组的**共识及同步消息/数据转发**。

### 6.2 A节点将B节点移除CA黑名单

场景描述：

节点1的CA黑名单中有节点2的nodeID，节点2的CA黑名单中没有节点1的nodeID，现在节点1将节点2移除自身的CA黑名单。

操作顺序：

1. 对于节点1，将节点2的公钥NodeID从自身的**CA黑名单**移除；
2. 重启节点1；
3. 使用netstat命令确认节点1与节点2重新建立连接，移除黑名单操作完成。


## 7 功能展望

- CA黑名单目前为修改后重启生效，后续可实现动态加载，修改实时生效；
- CA黑名单目前实现了基于节点的黑名单，后续可考虑基于机构的黑名单。

## 8 FAQ

1、 节点A添加节点B为CA黑名单后，节点A所在的部分账本无法共识？

节点A添加节点B为CA黑名单并重启后，节点A和节点B将不建立连接，无法进行P2P通信，继而无法发送/接收共识消息。当群组中有效节点数不满足3f+1容错条件时，将无法共识。

2、 如何实现账本层的黑名单？

可修改账本的共识节点系统表，该表实现了账本白名单和基于账本的黑名单功能，白名单/黑名单的使用可通过逐个添加/删除节点实现。